<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>æ£‹ç‰Œå®¤å€Ÿæ¬¾è®°è´¦</title>
  <!-- PWAé…ç½® -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4f46e5">
  <link rel="apple-touch-icon" href="icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="å€Ÿæ¬¾è®°è´¦">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
    }
    .card-shadow {
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
    }
    .card-shadow:hover {
      box-shadow: 0 6px 16px rgba(0,0,0,0.12);
      transform: translateY(-2px);
    }
    .fade-in {
      animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .slide-in {
      animation: slideIn 0.3s ease-in-out;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .pulse {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }
    .success-animation {
      animation: success 0.5s ease-in-out;
    }
    @keyframes success {
      0% { transform: scale(0.8); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    /* ç§»åŠ¨ç«¯è§¦æ‘¸ä¼˜åŒ– */
    @media (max-width: 640px) {
      .card-shadow {
        padding: 1rem;
      }
      button {
        min-height: 44px;
        touch-action: manipulation;
      }
      input {
        min-height: 44px;
        touch-action: manipulation;
      }
      .container {
        padding-left: 1rem;
        padding-right: 1rem;
      }
      h1 {
        font-size: 1.25rem;
      }
    }
    /* è§¦æ‘¸åé¦ˆ */
    .touch-feedback {
      transition: transform 0.1s ease;
    }
    .touch-feedback:active {
      transform: scale(0.98);
    }
  </style>
</head>
<body class="min-h-screen text-gray-800">

<!-- Header -->
<header class="bg-indigo-600 text-white p-4 shadow-md sticky top-0 z-10">
  <div class="container mx-auto flex justify-between items-center">
    <h1 class="text-xl font-bold"><i class="fas fa-coins mr-2"></i>æ£‹ç‰Œå®¤å€Ÿæ¬¾è®°è´¦</h1>
    <div class="flex space-x-2">
      <button id="copyStatusBtn" class="bg-white text-indigo-600 px-4 py-2 rounded-full hover:bg-indigo-700 transition duration-200">
        <i class="fas fa-calculator mr-1"></i>åˆè®¡
      </button>
      <button id="addBorrowerBtn" class="bg-white text-indigo-600 px-4 py-2 rounded-full hover:bg-indigo-700 transition duration-200">
        <i class="fas fa-user-plus mr-1"></i>æ–°å¢å€Ÿæ¬¾äºº
      </button>
    </div>
  </div>
</header>

<!-- Main Content -->
<main class="container mx-auto p-4 space-y-6">
  <!-- Borrower List -->
  <section id="borrowersList" class="space-y-4">
    <!-- åŠ¨æ€åŠ è½½å€Ÿæ¬¾äººå¡ç‰‡ -->
  </section>
</main>

<!-- Add Borrower Modal -->
<div id="addBorrowerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-start pt-20 z-20 fade-in">
  <div class="bg-white w-11/12 max-w-md rounded-lg card-shadow p-6 relative">
    <span class="absolute top-4 right-4 text-gray-500 cursor-pointer text-2xl" onclick="closeAddBorrower()">&times;</span>
    <h2 class="text-lg font-semibold mb-4">æ–°å¢å€Ÿæ¬¾äºº</h2>
    <input type="text" id="newBorrowerName" placeholder="è¯·è¾“å…¥å§“å" class="w-full border border-gray-300 rounded p-3 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-300">
    <button onclick="saveNewBorrower()" class="w-full bg-indigo-600 text-white py-3 rounded hover:bg-indigo-700 transition duration-200">ä¿å­˜</button>
  </div>
</div>

<!-- Record Detail Modal -->
<div id="recordDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-start pt-20 z-20 overflow-y-auto pb-10 fade-in">
  <div class="bg-white w-11/12 max-w-md rounded-lg card-shadow p-6 mt-10">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-semibold" id="modalTitle">å€Ÿæ¬¾è¯¦æƒ…</h2>
      <span class="text-gray-500 cursor-pointer text-2xl" onclick="closeRecordDetail()">&times;</span>
    </div>
    <div class="grid grid-cols-2 gap-4 mb-2">
      <div>
        <label class="block text-sm font-medium mb-1">å€Ÿæ¬¾æ—¥æœŸï¼š</label>
        <input type="date" id="recordDate" class="w-full border border-gray-300 rounded p-2">
        <button onclick="deleteBorrowerFromDetail()" class="mt-2 px-3 py-2 h-8 bg-gray-600 text-white rounded hover:bg-gray-700 transition duration-200 whitespace-nowrap text-sm flex items-center">
          <i class="fas fa-trash-alt mr-1"></i>åˆ é™¤å€Ÿæ¬¾äºº
        </button>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">é‡‘é¢(å…ƒ)ï¼š</label>
        <input type="number" id="recordAmount" placeholder="å€Ÿæ¬¾ä¸ºæ­£æ•°ï¼Œè¿˜æ¬¾ä¸ºè´Ÿæ•°" class="w-full border border-gray-300 rounded p-2">
        <div class="mt-2 flex justify-end space-x-2">
          <button onclick="deleteCurrentRecord()" class="px-3 py-2 h-8 bg-red-500 text-white rounded hover:bg-red-600 transition duration-200 whitespace-nowrap text-sm flex items-center">
            æ¸…ç©ºè®°å½•
          </button>
          <button onclick="saveRecord()" class="px-3 py-2 h-8 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition duration-200 whitespace-nowrap text-sm flex items-center">
            ä¿å­˜
          </button>
        </div>
      </div>
    </div>
    
    <!-- Records Table -->
    <div class="mt-6">
      <h3 class="font-medium mb-2">å€Ÿæ¬¾è®°å½•</h3>
      <table class="w-full text-left text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="p-2">æ—¥æœŸ</th>
            <th class="p-2">ç±»å‹</th>
            <th class="p-2">é‡‘é¢</th>
            <th class="p-2">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="recordsTableBody">
          <!-- åŠ¨æ€å¡«å……è®°å½• -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // åˆå§‹åŒ–æ•°æ®ç»“æ„
  let borrowers = loadBorrowersFromStorage();

  // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
  function loadBorrowersFromStorage() {
    try {
      const data = localStorage.getItem('borrowers');
      if (!data) {
        return [];
      }
      const parsedData = JSON.parse(data);
      // éªŒè¯æ•°æ®ç»“æ„
      if (!Array.isArray(parsedData)) {
        console.error('æ•°æ®ç»“æ„é”™è¯¯ï¼ŒæœŸæœ›æ•°ç»„');
        return [];
      }
      // éªŒè¯æ¯ä¸ªå€Ÿæ¬¾äººå¯¹è±¡çš„ç»“æ„
      return parsedData.map(item => {
        if (!item.name || !Array.isArray(item.records)) {
          console.error('å€Ÿæ¬¾äººæ•°æ®ç»“æ„é”™è¯¯:', item);
          return { name: item.name || 'æœªçŸ¥', records: [] };
        }
        return item;
      });
    } catch (error) {
      console.error('åŠ è½½æ•°æ®æ—¶å‡ºé”™:', error);
      return [];
    }
  }

  // é˜²æŠ–å‡½æ•° - å…¼å®¹ä¸åŒæµè§ˆå™¨
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆé˜²æŠ–ç‰ˆï¼‰
  const saveBorrowersToStorage = debounce(() => {
    try {
      localStorage.setItem('borrowers', JSON.stringify(borrowers));
      return true;
    } catch (error) {
      console.error('ä¿å­˜æ•°æ®æ—¶å‡ºé”™:', error);
      return false;
    }
  }, 300);

  // é¡µé¢åŠ è½½å®Œæˆåæ¸²æŸ“åˆ—è¡¨
  document.addEventListener('DOMContentLoaded', () => {
    renderBorrowers();
  });

  // æ¸²æŸ“å€Ÿæ¬¾äººåˆ—è¡¨
  function renderBorrowers() {
    const container = document.getElementById('borrowersList');
    container.innerHTML = '';
    if (borrowers.length === 0) {
      container.innerHTML = `
        <div class="text-center py-10 text-gray-500">
          <i class="fas fa-users-slash text-4xl mb-3"></i>
          <p>æš‚æ— å€Ÿæ¬¾äººä¿¡æ¯<br><small>è¯·ç‚¹å‡»å³ä¸Šè§’æ·»åŠ </small></p>
        </div>`;
      return;
    }
    borrowers.forEach((person, index) => {
      // è®¡ç®—å‡€æ¬ æ¬¾ï¼ˆæ­£æ•°ä¸ºæ¬ æ¬¾ï¼Œè´Ÿæ•°ä¸ºå¤šè¿˜ï¼‰
      const netDebt = person.records.reduce((sum, r) => {
        try {
          return sum + parseFloat(r.amount || 0);
        } catch (error) {
          console.error('è®¡ç®—é‡‘é¢æ—¶å‡ºé”™:', error);
          return sum;
        }
      }, 0);
      const displayDebt = Math.abs(netDebt).toFixed(2);
      const card = document.createElement('div');
      card.className = "bg-white rounded-lg card-shadow p-3 fade-in cursor-move";
      card.draggable = true;
      card.dataset.index = index;
      card.innerHTML = `
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-bold text-base">${person.name}</h3>
            <p class="text-gray-600 text-xs">å½“å‰çŠ¶æ€ï¼š<span class="${netDebt >= 0 ? 'text-red-500' : 'text-green-500'} font-semibold">Â¥${displayDebt} ${netDebt >= 0 ? 'æœªè¿˜' : 'è¶…è¿˜'}</span></p>
          </div>
          <div class="flex space-x-2">
            <button onclick="openRecordDetail(${index})" class="text-blue-500 hover:text-blue-700">
              <i class="fas fa-edit"></i>
            </button>
            <span class="text-gray-400 hover:text-gray-600"><i class="fas fa-grip-vertical"></i></span>
          </div>
        </div>
      `;
      // æ·»åŠ æ‹–æ‹½äº‹ä»¶ç›‘å¬å™¨
      // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œé¿å…å†…å­˜æ³„æ¼
      // ä¸€æ¬¡æ€§æ·»åŠ æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
      const addDragListeners = (element) => {
        element.addEventListener('dragstart', handleDragStart);
        element.addEventListener('dragover', handleDragOver);
        element.addEventListener('dragleave', handleDragLeave);
        element.addEventListener('drop', handleDrop);
        element.addEventListener('dragend', handleDragEnd);
      };
      addDragListeners(card);
      container.appendChild(card);
    });
  }

  // æ‹–æ‹½å¼€å§‹äº‹ä»¶
  let draggedElement = null;
  function handleDragStart(e) {
    draggedElement = this;
    this.classList.add('opacity-50', 'scale-105', 'shadow-lg');
    this.style.zIndex = '1000';
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
    // æ›´æ”¹å…‰æ ‡æ ·å¼
    document.body.style.cursor = 'grabbing';
  }

  // æ‹–æ‹½ç»è¿‡äº‹ä»¶
  function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    // æ·»åŠ ç›®æ ‡ä½ç½®é«˜äº®æ•ˆæœ
    this.classList.add('bg-gray-100', 'ring-2', 'ring-indigo-300');
    const draggedIndex = parseInt(draggedElement.dataset.index);
    const targetIndex = parseInt(this.dataset.index);
    if (draggedIndex !== targetIndex) {
      const container = document.getElementById('borrowersList');
      const children = Array.from(container.children);
      const draggedElementIndex = children.indexOf(draggedElement);
      const targetElementIndex = children.indexOf(this);
      if (draggedElementIndex < targetElementIndex) {
        container.insertBefore(draggedElement, this.nextSibling);
      } else {
        container.insertBefore(draggedElement, this);
      }
    }
  }

  // æ‹–æ‹½ç¦»å¼€äº‹ä»¶
  function handleDragLeave() {
    this.classList.remove('bg-gray-100', 'ring-2', 'ring-indigo-300');
  }

  // æ‹–æ‹½æ”¾ç½®äº‹ä»¶
  function handleDrop(e) {
    e.preventDefault();
    // ç§»é™¤æ‰€æœ‰ä¸´æ—¶æ ·å¼
    this.classList.remove('bg-gray-100', 'ring-2', 'ring-indigo-300');
    draggedElement.classList.remove('opacity-50', 'scale-105', 'shadow-lg');
    draggedElement.style.zIndex = '';
    document.body.style.cursor = '';
    // æ›´æ–°æ•°æ®é¡ºåº
    const container = document.getElementById('borrowersList');
    const cards = container.querySelectorAll('[data-index]');
    const newOrder = Array.from(cards).map(card => {
      const originalIndex = parseInt(card.dataset.index);
      return borrowers[originalIndex];
    });
    borrowers = newOrder;
    saveBorrowersToStorage();
    // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°ç´¢å¼•
    renderBorrowers();
  }

  // æ·»åŠ æ‹–æ‹½ç»“æŸäº‹ä»¶
  function handleDragEnd() {
    this.classList.remove('opacity-50', 'scale-105', 'shadow-lg');
    this.style.zIndex = '';
    document.body.style.cursor = '';
    // æ¸…é™¤æ‰€æœ‰ç›®æ ‡ä½ç½®çš„ä¸´æ—¶æ ·å¼
    const cards = document.querySelectorAll('#borrowersList [data-index]');
    cards.forEach(card => {
      card.classList.remove('bg-gray-100', 'ring-2', 'ring-indigo-300');
    });
  }

  // æ‰“å¼€æ–°å¢å€Ÿæ¬¾äººå¼¹çª—
  function openAddBorrower() {
    document.getElementById('addBorrowerModal').classList.remove('hidden');
  }

  document.getElementById('addBorrowerBtn').addEventListener('click', openAddBorrower);
  document.getElementById('copyStatusBtn').addEventListener('click', copyAllStatus);

  // æ˜¾ç¤ºåˆè®¡å¹¶å¤åˆ¶åˆ°å‰ªè´´æ¿
  function copyAllStatus() {
    try {
      if (borrowers.length === 0) {
        alert('æš‚æ— å€Ÿæ¬¾äººä¿¡æ¯');
        return;
      }
      
      // ç”ŸæˆçŠ¶æ€æ–‡æœ¬
      let statusText = 'æ£‹ç‰Œå®¤å€Ÿæ¬¾è®°è´¦åˆè®¡\n';
      statusText += '==================\n';
      statusText += new Date().toLocaleString('zh-CN') + '\n\n';
      
      // ç”ŸæˆHTMLå†…å®¹ç”¨äºå¼¹çª—
      let htmlContent = '<div class="space-y-2">';
      
      let count = 0;
      borrowers.forEach((person, index) => {
        // è®¡ç®—å‡€æ¬ æ¬¾ï¼ˆæ­£æ•°ä¸ºæ¬ æ¬¾ï¼Œè´Ÿæ•°ä¸ºå¤šè¿˜ï¼‰
        const netDebt = person.records.reduce((sum, r) => sum + parseFloat(r.amount), 0);
        
        // è¿‡æ»¤æ‰æœªè¿˜é‡‘é¢ä¸º0çš„å€Ÿæ¬¾äºº
        if (Math.abs(netDebt) < 0.01) {
          return;
        }
        
        count++;
        const displayDebt = Math.abs(netDebt).toFixed(2);
        const status = netDebt >= 0 ? 'æœªè¿˜' : 'è¶…è¿˜';
        const color = netDebt >= 0 ? 'ğŸ”´' : 'ğŸŸ¢';
        
        // æ·»åŠ åˆ°æ–‡æœ¬
        statusText += `${count}. ${person.name}\n`;
        statusText += `   ${color} ${status}: Â¥${displayDebt}\n\n`;
        
        // æ·»åŠ åˆ°HTML
        const statusClass = netDebt >= 0 ? 'text-red-500' : 'text-green-500';
        htmlContent += `
          <div class="flex justify-between items-center py-1 border-b border-gray-200">
            <span>${count}. ${person.name}</span>
            <span class="${statusClass} font-semibold">${status}: Â¥${displayDebt}</span>
          </div>
        `;
      });
      
      // å¦‚æœæ‰€æœ‰å€Ÿæ¬¾äººçš„æœªè¿˜é‡‘é¢éƒ½ä¸º0
      if (count === 0) {
        htmlContent += `
          <div class="text-center py-4 text-gray-500">
            <i class="fas fa-check-circle text-green-500 text-2xl mb-2"></i>
            <p>æ‰€æœ‰å€Ÿæ¬¾äººçš„æœªè¿˜é‡‘é¢éƒ½ä¸º0</p>
          </div>
        `;
        statusText = 'æ£‹ç‰Œå®¤å€Ÿæ¬¾è®°è´¦åˆè®¡\n';
        statusText += '==================\n';
        statusText += new Date().toLocaleString('zh-CN') + '\n\n';
        statusText += 'æ‰€æœ‰å€Ÿæ¬¾äººçš„æœªè¿˜é‡‘é¢éƒ½ä¸º0\n\n';
        statusText += '==================\n';
        statusText += 'æ€»æ¬ æ¬¾: Â¥0.00\n';
      }
      
      // è®¡ç®—æ€»æ¬ æ¬¾
      const totalDebt = borrowers.reduce((sum, person) => {
        const personDebt = person.records.reduce((sum, r) => sum + parseFloat(r.amount), 0);
        return sum + personDebt;
      }, 0);
      const displayTotalDebt = Math.abs(totalDebt).toFixed(2);
      const totalStatus = totalDebt >= 0 ? 'æ€»æ¬ æ¬¾' : 'æ€»è¶…è¿˜';
      
      // æ·»åŠ æ€»è®¡åˆ°æ–‡æœ¬
      statusText += '==================\n';
      statusText += `${totalStatus}: Â¥${displayTotalDebt}\n`;
      
      // æ·»åŠ æ€»è®¡åˆ°HTML
      const totalClass = totalDebt >= 0 ? 'text-red-600' : 'text-green-600';
      htmlContent += `
        <div class="mt-4 pt-2 border-t border-gray-300">
          <div class="flex justify-between items-center font-bold ${totalClass}">
            <span>æ€»è®¡</span>
            <span>${totalStatus}: Â¥${displayTotalDebt}</span>
          </div>
        </div>
      `;
      
      htmlContent += '</div>';
      
      // æ˜¾ç¤ºå¼¹çª—
      showStatusModal(htmlContent, statusText);
      
    } catch (error) {
      console.error('æ˜¾ç¤ºåˆè®¡æ—¶å‡ºé”™:', error);
      alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }

  // æ˜¾ç¤ºçŠ¶æ€å¼¹çª—
  function showStatusModal(content, statusText) {
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å¼¹çª—
    let modal = document.getElementById('statusModal');
    if (modal) {
      modal.remove();
    }
    
    // åˆ›å»ºå¼¹çª—
    modal = document.createElement('div');
    modal.id = 'statusModal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50';
    modal.innerHTML = `
      <div class="bg-white w-11/12 max-w-md rounded-lg card-shadow p-6 relative max-h-[80vh] overflow-y-auto">
        <span class="absolute top-4 right-4 text-gray-500 cursor-pointer text-2xl" onclick="document.getElementById('statusModal').remove()">&times;</span>
        <h2 class="text-lg font-semibold mb-4">å€Ÿæ¬¾è®°è´¦åˆè®¡</h2>
        <div class="mb-6">${content}</div>
        <div class="flex space-x-2">
          <button onclick="copyTextToClipboard('${statusText.replace(/\n/g, '\\n')}'); document.getElementById('statusModal').remove()" 
                  class="flex-1 bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 transition duration-200 touch-feedback">
            <i class="fas fa-copy mr-1"></i>å¤åˆ¶åˆ°å‰ªè´´æ¿
          </button>
          <button onclick="document.getElementById('statusModal').remove()" 
                  class="flex-1 bg-gray-300 text-gray-700 py-2 rounded hover:bg-gray-400 transition duration-200 touch-feedback">
            <i class="fas fa-times mr-1"></i>å…³é—­
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
  }

  // å¤åˆ¶åˆ°å‰ªè´´æ¿
  function copyToClipboard(text) {
    // è§£ç æ¢è¡Œç¬¦
    text = text.replace(/\\n/g, '\n');
    
    if (navigator.clipboard && window.isSecureContext) {
      // ç°ä»£æµè§ˆå™¨
      navigator.clipboard.writeText(text).then(() => {
        alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
      }).catch(err => {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        fallbackCopyTextToClipboard(text);
      });
    } else {
      // å…¼å®¹æ€§å¤„ç†
      fallbackCopyTextToClipboard(text);
    }
  }

  // å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
  function copyTextToClipboard(text) {
    try {
      // è§£ç æ¢è¡Œç¬¦
      text = text.replace(/\n/g, '\n');
      
      if (navigator.clipboard && window.isSecureContext) {
        // ç°ä»£æµè§ˆå™¨
        navigator.clipboard.writeText(text).then(() => {
          alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }).catch(err => {
          console.error('å¤åˆ¶åˆ°å‰ªè´´æ¿å¤±è´¥:', err);
          fallbackCopyTextToClipboard(text);
        });
      } else {
        // å…¼å®¹æ€§å¤„ç†
        fallbackCopyTextToClipboard(text);
      }
    } catch (error) {
      console.error('å¤åˆ¶åˆ°å‰ªè´´æ¿æ—¶å‡ºé”™:', error);
      alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }

  // å…¼å®¹æ€§å¤åˆ¶å‡½æ•°
  function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
      const successful = document.execCommand('copy');
      const msg = successful ? 'çŠ¶æ€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿' : 'å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶';
      alert(msg);
    } catch (err) {
      console.error('fallbackå¤åˆ¶å¤±è´¥:', err);
      alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
    }
    
    document.body.removeChild(textArea);
  }

  // å…³é—­æ–°å¢å€Ÿæ¬¾äººå¼¹çª—
  function closeAddBorrower() {
    document.getElementById('addBorrowerModal').classList.add('hidden');
    document.getElementById('newBorrowerName').value = '';
  }

  // ä¿å­˜æ–°å€Ÿæ¬¾äºº
  function saveNewBorrower() {
    try {
      const nameInput = document.getElementById('newBorrowerName');
      let name = nameInput.value.trim();
      
      // è¾“å…¥éªŒè¯
      if (!name) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å§“å");
        return;
      }
      
      // é˜²æ­¢XSSæ”»å‡»ï¼Œè¿‡æ»¤ç‰¹æ®Šå­—ç¬¦
      name = name.replace(/[<>&"'\\]/g, (char) => {
        const map = {
          '<': '&lt;',
          '>': '&gt;',
          '&': '&amp;',
          '"': '&quot;',
          "'": '&#39;',
          '\\': '&#92;'
        };
        return map[char];
      });
      
      // æ£€æŸ¥é‡å
      if (borrowers.some(p => p.name === name)) {
        alert("è¯¥å€Ÿæ¬¾äººå·²å­˜åœ¨ï¼");
        return;
      }
      
      borrowers.push({ name, records: [] });
      saveBorrowersToStorage();
      renderBorrowers();
      closeAddBorrower();
    } catch (error) {
      console.error('ä¿å­˜æ–°å€Ÿæ¬¾äººæ—¶å‡ºé”™:', error);
      alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }

  // åˆ é™¤å€Ÿæ¬¾äºº
  function deleteBorrower(index) {
    try {
      if (index < 0 || index >= borrowers.length) {
        alert('å€Ÿæ¬¾äººä¸å­˜åœ¨');
        return;
      }
      if (confirm(`ç¡®å®šåˆ é™¤ "${borrowers[index].name}" å—ï¼Ÿ`)) {
        borrowers.splice(index, 1);
        saveBorrowersToStorage();
        renderBorrowers();
      }
    } catch (error) {
      console.error('åˆ é™¤å€Ÿæ¬¾äººæ—¶å‡ºé”™:', error);
      alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }

  // å½“å‰æ­£åœ¨ç¼–è¾‘çš„å€Ÿæ¬¾äººç´¢å¼•
  let currentEditIndex = null;
  // åˆ†é¡µç›¸å…³å˜é‡
  let currentPage = 1;
  const recordsPerPage = 5;

  // æ‰“å¼€è®°å½•è¯¦æƒ…å¼¹çª—
  function openRecordDetail(index) {
    try {
      if (index < 0 || index >= borrowers.length) {
        console.error('æ— æ•ˆçš„å€Ÿæ¬¾äººç´¢å¼•:', index);
        alert('å€Ÿæ¬¾äººä¸å­˜åœ¨');
        return;
      }
      currentEditIndex = index;
      const borrower = borrowers[index];
      if (!borrower) {
        console.error('å€Ÿæ¬¾äººä¸å­˜åœ¨:', index);
        alert('å€Ÿæ¬¾äººä¸å­˜åœ¨');
        return;
      }
      document.getElementById('modalTitle').textContent = `å€Ÿæ¬¾è¯¦æƒ… - ${borrower.name}`;
      loadRecordsIntoTable(borrower.records || []);
      addBlankRecord(); // åˆå§‹åŒ–ä¸ºç©ºç™½è®°å½•
      document.getElementById('recordDetailModal').classList.remove('hidden');
    } catch (error) {
      console.error('æ‰“å¼€è®°å½•è¯¦æƒ…æ—¶å‡ºé”™:', error);
      alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }

  // åŠ è½½è®°å½•åˆ°è¡¨æ ¼
  function loadRecordsIntoTable(records) {
    const tbody = document.getElementById('recordsTableBody');
    tbody.innerHTML = '';
    if (records.length === 0) {
      tbody.innerHTML = `<tr><td colspan='4' class='text-center py-2 text-gray-500'>æš‚æ— è®°å½•</td></tr>`;
      renderPaginationControls([]);
      return;
    }
    // ç›´æ¥ä½¿ç”¨åŸå§‹é¡ºåºï¼ˆæ–°è®°å½•å·²é€šè¿‡unshiftæ·»åŠ åˆ°å¼€å¤´ï¼‰
    const displayRecords = [...records];
    // è®¡ç®—åˆ†é¡µä¿¡æ¯
    currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
    const totalPages = Math.ceil(displayRecords.length / recordsPerPage);
    // æ˜¾ç¤ºå½“å‰é¡µè®°å½•
    const startIndex = (currentPage - 1) * recordsPerPage;
    const endIndex = startIndex + recordsPerPage;
    const currentPageRecords = displayRecords.slice(startIndex, endIndex);
    currentPageRecords.forEach((r, i) => {
      const amount = parseFloat(r.amount);
      const type = amount > 0 ? 'å€Ÿæ¬¾' : 'è¿˜æ¬¾';
      const colorClass = amount > 0 ? 'text-red-500' : 'text-green-500';
      const displayAmount = Math.abs(amount).toFixed(2);
      // è®¡ç®—åŸå§‹ç´¢å¼•ï¼ˆç”¨äºç¼–è¾‘å’Œåˆ é™¤ï¼‰
      const originalIndex = records.findIndex(record => 
        record.date === r.date && record.amount == r.amount
      );
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="p-2">${r.date}</td>
        <td class="p-2">${type}</td>
        <td class="p-2 ${colorClass}">Â¥${displayAmount}</td>
        <td class="p-2">
          <button onclick="editRecord(${originalIndex})" class="text-blue-500 hover:text-blue-700 mr-2"><i class="fas fa-pencil-alt"></i></button>
          <button onclick="removeRecord(${originalIndex})" class="text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
        </td>
      `;
      tbody.appendChild(row);
    });
    // æ¸²æŸ“åˆ†é¡µæ§ä»¶
    renderPaginationControls(displayRecords);
  }

  // æ¸²æŸ“åˆ†é¡µæ§ä»¶
  function renderPaginationControls(records) {
    const tableContainer = document.querySelector('#recordDetailModal table').parentElement;
    // ç§»é™¤æ—§çš„åˆ†é¡µæ§ä»¶
    const oldPagination = tableContainer.querySelector('.pagination');
    if (oldPagination) {
      oldPagination.remove();
    }
    if (records.length <= recordsPerPage) {
      return; // ä¸éœ€è¦åˆ†é¡µ
    }
    const totalPages = Math.ceil(records.length / recordsPerPage);
    const pagination = document.createElement('div');
    pagination.className = 'pagination flex justify-center mt-4 space-x-1';
    // ä¸Šä¸€é¡µæŒ‰é’®
    const prevBtn = document.createElement('button');
    prevBtn.className = `px-3 py-1 border rounded ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100'}`;
    prevBtn.disabled = currentPage === 1;
    prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
    prevBtn.addEventListener('click', () => {
      if (currentPage > 1) {
        changePage(currentPage - 1, records);
      }
    });
    pagination.appendChild(prevBtn);
    // é¡µç æŒ‰é’®
    for (let i = 1; i <= totalPages; i++) {
      const pageBtn = document.createElement('button');
      pageBtn.className = `px-3 py-1 border rounded ${currentPage === i ? 'bg-indigo-600 text-white' : 'hover:bg-gray-100'}`;
      pageBtn.textContent = i;
      pageBtn.addEventListener('click', () => {
        changePage(i, records);
      });
      pagination.appendChild(pageBtn);
    }
    // ä¸‹ä¸€é¡µæŒ‰é’®
    const nextBtn = document.createElement('button');
    nextBtn.className = `px-3 py-1 border rounded ${currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100'}`;
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
    nextBtn.addEventListener('click', () => {
      if (currentPage < totalPages) {
        changePage(currentPage + 1, records);
      }
    });
    pagination.appendChild(nextBtn);
    tableContainer.appendChild(pagination);
  }

  // åˆ‡æ¢é¡µé¢
  function changePage(page, records) {
    const totalPages = Math.ceil(records.length / recordsPerPage);
    if (page < 1 || page > totalPages) {
      return;
    }
    currentPage = page;
    const tbody = document.getElementById('recordsTableBody');
    tbody.innerHTML = '';
    // æ˜¾ç¤ºå½“å‰é¡µè®°å½•
    const startIndex = (currentPage - 1) * recordsPerPage;
    const endIndex = startIndex + recordsPerPage;
    const currentPageRecords = records.slice(startIndex, endIndex);
    currentPageRecords.forEach((r, i) => {
      const amount = parseFloat(r.amount);
      const type = amount > 0 ? 'å€Ÿæ¬¾' : 'è¿˜æ¬¾';
      const colorClass = amount > 0 ? 'text-red-500' : 'text-green-500';
      const displayAmount = Math.abs(amount).toFixed(2);
      // è®¡ç®—åŸå§‹ç´¢å¼•ï¼ˆç”¨äºç¼–è¾‘å’Œåˆ é™¤ï¼‰
      const originalIndex = borrowers[currentEditIndex].records.findIndex(record => 
        record.date === r.date && record.amount == r.amount
      );
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="p-2">${r.date}</td>
        <td class="p-2">${type}</td>
        <td class="p-2 ${colorClass}">Â¥${displayAmount}</td>
        <td class="p-2">
          <button onclick="editRecord(${originalIndex})" class="text-blue-500 hover:text-blue-700 mr-2"><i class="fas fa-pencil-alt"></i></button>
          <button onclick="removeRecord(${originalIndex})" class="text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
        </td>
      `;
      tbody.appendChild(row);
    });
    // æ›´æ–°åˆ†é¡µæ§ä»¶
    renderPaginationControls(records);
  }

  // æ–°å¢ä¸€æ¡ç©ºç™½è®°å½•
  function addBlankRecord() {
    const dateField = document.getElementById('recordDate');
    const amountField = document.getElementById('recordAmount');

    const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
    dateField.value = today;
    amountField.value = '';

    // è®¾ç½®ç„¦ç‚¹ä»¥ä¾¿å¿«é€Ÿè¾“å…¥
    setTimeout(() => amountField.focus(), 100);
  }

  // ç¼–è¾‘å·²æœ‰è®°å½•
  function editRecord(recordIndex) {
    const record = borrowers[currentEditIndex].records[recordIndex];
    document.getElementById('recordDate').value = record.date;
    document.getElementById('recordAmount').value = record.amount;
  }

  // ç§»é™¤æŒ‡å®šè®°å½•
  function removeRecord(recordIndex) {
    try {
      if (currentEditIndex === null) return;
      if (confirm("ç¡®å®šç§»é™¤æ­¤æ¡è®°å½•å—ï¼Ÿ")) {
        borrowers[currentEditIndex].records.splice(recordIndex, 1);
        saveBorrowersToStorage();
        currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
        loadRecordsIntoTable(borrowers[currentEditIndex].records);
      }
    } catch (error) {
      console.error('ç§»é™¤è®°å½•æ—¶å‡ºé”™:', error);
      alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }

  // ä¿å­˜å½“å‰è®°å½•ï¼ˆæ–°å»ºæˆ–ä¿®æ”¹ï¼‰
  function saveRecord() {
    try {
      if (currentEditIndex === null) {
        console.error('æœªé€‰æ‹©å€Ÿæ¬¾äºº');
        alert('æœªé€‰æ‹©å€Ÿæ¬¾äºº');
        return;
      }
      const date = document.getElementById('recordDate').value;
      const amount = document.getElementById('recordAmount').value;

      if (!date || !amount) {
        alert("è¯·å¡«å†™æ—¥æœŸå’Œé‡‘é¢");
        return;
      }

      // éªŒè¯æ—¥æœŸæ ¼å¼
      const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
      if (!dateRegex.test(date)) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¥æœŸæ ¼å¼");
        return;
      }

      const parsedAmount = parseFloat(amount);
      if (isNaN(parsedAmount)) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢æ•°å­—");
        return;
      }

      // éªŒè¯å€Ÿæ¬¾äººå­˜åœ¨
      if (!borrowers[currentEditIndex]) {
        console.error('å€Ÿæ¬¾äººä¸å­˜åœ¨:', currentEditIndex);
        alert('å€Ÿæ¬¾äººä¸å­˜åœ¨');
        return;
      }

      // ç›´æ¥æ·»åŠ æ–°è®°å½•ï¼Œå…è®¸åŒä¸€æ—¥æœŸåŒä¸€é‡‘é¢çš„å¤šæ¡è®°å½•å­˜åœ¨
      // æ·»åŠ æ–°è®°å½•åˆ°å¼€å¤´ï¼Œç¡®ä¿æœ€è¿‘æ·»åŠ çš„æ˜¾ç¤ºåœ¨æœ€å‰é¢
      borrowers[currentEditIndex].records.unshift({ date, amount: parsedAmount.toString() });

      // ä¼˜åŒ–localStorageå­˜å‚¨ï¼Œå‡å°‘é¢‘ç¹å†™å…¥
      saveBorrowersToStorage();
      currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
      loadRecordsIntoTable(borrowers[currentEditIndex].records);
      addBlankRecord(); // æ¸…ç©ºå­—æ®µå‡†å¤‡ä¸‹æ¬¡è¾“å…¥
    } catch (error) {
      console.error('ä¿å­˜è®°å½•æ—¶å‡ºé”™:', error);
      alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }

  // åˆ é™¤æ•´ä¸ªå€Ÿæ¬¾äººçš„å…¨éƒ¨è®°å½•
  function deleteCurrentRecord() {
    try {
      if (currentEditIndex === null) return;
      if (confirm("è¿™å°†æ¸…ç©ºæ­¤äººæ‰€æœ‰çš„å€Ÿæ¬¾è®°å½•ï¼\næ˜¯å¦ç»§ç»­ï¼Ÿ")) {
        borrowers[currentEditIndex].records = [];
        saveBorrowersToStorage();
        currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
        loadRecordsIntoTable([]);
      }
    } catch (error) {
      console.error('æ¸…ç©ºè®°å½•æ—¶å‡ºé”™:', error);
      alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }

  // ä»ç¼–è¾‘é¡µé¢åˆ é™¤å€Ÿæ¬¾äºº
  function deleteBorrowerFromDetail() {
    try {
      if (currentEditIndex === null) return;
      const borrowerName = borrowers[currentEditIndex].name;
      if (confirm(`ç¡®å®šåˆ é™¤ "${borrowerName}" å—ï¼Ÿ\næ­¤æ“ä½œå°†åˆ é™¤è¯¥å€Ÿæ¬¾äººçš„æ‰€æœ‰è®°å½•ï¼`)) {
        borrowers.splice(currentEditIndex, 1);
        saveBorrowersToStorage();
        closeRecordDetail();
        renderBorrowers();
      }
    } catch (error) {
      console.error('åˆ é™¤å€Ÿæ¬¾äººæ—¶å‡ºé”™:', error);
      alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }

  // å…³é—­è®°å½•è¯¦æƒ…å¼¹çª—
  function closeRecordDetail() {
    document.getElementById('recordDetailModal').classList.add('hidden');
    currentEditIndex = null;
    renderBorrowers(); // æ›´æ–°ä¸»é¡µç»Ÿè®¡æ•°æ®
  }

  // æ³¨å†ŒService Worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('service-worker.js')
        .then(registration => {
          console.log('Service Worker æ³¨å†ŒæˆåŠŸ:', registration.scope);
        })
        .catch(error => {
          console.log('Service Worker æ³¨å†Œå¤±è´¥:', error);
        });
    });
  }
</script>
</body>
</html>